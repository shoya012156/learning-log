# products_files テーブルの振り返りメモ

## 1. 課題発見と設計改善への貢献

### 設計の課題発見
従来の設計（products テーブル内にファイル情報を直接持つ）では、

- 複数枚投稿
- サムネイルと本体画像の分離
- 拡張性の確保

といった要件に対応できない問題を発見。

### 改善提案と設計変更
- **products（1）対 products_files（多）** の 1対多リレーションに変更するよう提案。
- マイグレーション修正も担当。
- データモデリングの基本原則に沿って、柔軟な画像管理基盤を構築。

### 機能仕様の定義
チームで以下の仕様を定義し、実装に落とし込んだ：

- ユーザーは「アップロードするだけ」
- システム側が自動で整形・トリミングを行う  
→ UX を最優先とした設計判断

---

## 2. Seeder/Factoryで苦戦した点と複雑なロジック設計 

このテーブルのSeeder作成は、

- **ランダム性**
- **厳密な整合性**

という相反する2つの要件を両立する必要があり、最も高度なロジック設計が求められた。

---

### A. データ整合性を保証するための工夫

#### ファイル情報カラムの設計

- **original_filename**  
  - AI生成の日本語／英語混在のファイル名を生成  
  - 文字コードやバリデーションのテストに備える目的

- **stored_filename**  
  - UUID + ランダムな拡張子  
  - 重複防止とセキュリティ考慮

- **file_path / small_path / large_path**  
  - 実データに近い画像パスを設定  
  - UI/UX確認を本番に近い状態で実施可能にした

---

### B. 最大の難所：複合的な条件を持つフラグ管理ロジックの実装

最も苦戦したのは、**「特定の product_id の中でのみ成立する制約」** をランダムに成立させるロジック。

#### 課題となった要件

- **is_thumbnail**  
  - 各 product ごとにサムネイルは必ず1つ  
  - ランダム生成しつつ、1つだけ選ばせる必要がある

- **display_order**  
  - 1つの product 内で画像の順番が連番  
  - 外側のループとは別で管理しないと整合性が壊れる

---

### 採用した解決ロジック（実装）

1. 親テーブル（products）をすべて foreach
2. 子要素の **枚数（$count）** をランダム決定
3. **サムネイルのインデックス（$thumbnailIndex）** を  
   1〜$count の範囲でランダムに事前決定
4. 内側 foreach で  
   - `display_order = $i` を順番に割り振る  
   - `$i === $thumbnailIndex` の場合のみ `is_thumbnail = true`

→ **外側のループでランダム決定し、内側のループで整合性を保証する**  
という構造により、ランダム性と制約遵守を両立できた。

---

## 3. 学びと最大の成果 

### 最大の学び（データモデリング）
- 機能要件（複数画像・自動整形）を満たすためには、
  既存の設計に固執せず、最適なデータ構造（1対多）を提案することが重要。
- DBマイグレーション修正まで含めて主体的に動くことで、
  開発の品質とスピードを大きく向上できると実感。

### 最大の学び（ロジック設計）
- Seeder/Factoryはただのダミーデータ生成ではなく、  
  **ビジネスロジック（例：is_thumbnail の制約）をデータで表現する場**。
- 制約をクリアしつつランダムなテストデータを生成するスキルを獲得。


